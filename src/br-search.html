<link rel="import" href="../../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">

<dom-module id="br-search">

  <link rel="import" type="css" href="../dist/css/br-search.min.css">

  <template>

    <iron-a11y-keys target="{{searchTarget}}" keys="esc" on-keys-pressed="_close"></iron-a11y-keys>
    <iron-a11y-keys target="{{inputTarget}}" keys="down" on-keys-pressed="_first"></iron-a11y-keys>
    <iron-a11y-keys target="{{listTarget}}" keys="up" on-keys-pressed="_previous"></iron-a11y-keys>
    <iron-a11y-keys target="{{listTarget}}" keys="down" on-keys-pressed="_next"></iron-a11y-keys>
    <iron-a11y-keys target="{{listTarget}}" keys="enter space" on-keys-pressed="_itemSelected"></iron-a11y-keys>

    <button class="header--btn close_search" on-click="_close">
      <br-icons icon="br-icons:arrow-back"></br-icons>
    </button>

    <button class="btn__search" on-click="_open">
      <br-icons icon="br-icons:search"></br-icons>
    </button>

    <template is="dom-if" if="{{loading}}">
      <br-icons icon="br-icons:loading" class="icon__spin"></br-icons>
    </template>

    <array-selector id="selector" items="[[ajaxResponse.Data]]" selected="{{selected}}"></array-selector>

    <input type="text"
           id="inputSearch"
           class="input__search"
           value="{{searchString::input}}"
           placeholder="{{placeholder}}"
           on-input="_onInput">

    <div class="overlay" on-click="_close"></div>

    <div class="content">

      <iron-ajax id="searchRequest"
                 url="{{urlApiRequest}}"
                 params="{{params}}"
                 handle-as="json"
                 last-response="{{ajaxResponse}}"
                 debounce-duration="300"
                 loading></iron-ajax>

      <ul id="list" class="list">

        <template is="dom-repeat"
                  id="templateList"
                  items="[[ajaxResponse.Data]]"
                  filter="{{_computefilter(searchString)}}">

          <li tabindex="-1"
              data-key$="[[item.key]]"
              on-click="_itemSelected"
              on-focus="_itemFocused">[[item.value]]</li>

        </template>

      </ul>

    </div>

  </template>

  <script>

    Polymer({
      is: 'br-search',

      properties: {

        placeholder: String,

        minLength: {
          type: Number,
          value: 1
        },

        limit: {
          type: Number,
          value: 10
        },

        searchTarget: {
          type: Object,
          value: function () {
            return this;
          }
        },

        inputTarget: {
          type: Object,
          value: function () {
            return this.$.inputSearch;
          }
        },

        listTarget: {
          type: Object,
          value: function () {
            return this.$.list;
          }
        }

      },

      _first: function () {
        this.$.list.firstElementChild.focus();
      },

      _previous: function () {
        this.$$(':focus').previousElementSibling.focus();
      },

      _next: function () {
        this.$$(':focus').nextElementSibling.focus();
      },

      _open: function (event) {
        this.$$('input').focus();
        this.classList.add('open');
        document.querySelector('br-header').classList.add('search_opened');
      },

      _close: function (event) {
        this.$.inputSearch.value = '';
        this.classList.remove('open');
        document.querySelector('br-header').classList.remove('search_opened');
      },

      _onInput: function ( event ) {
        if ( event.target.value.length >= this.minLength ) {
          this.params = { query: event.target.value, limit: this.limit };
          this.$.searchRequest.generateRequest();
          this.loading = this.$.searchRequest.loading;
          this._open();
        }
        else if ( event.target.value.length == 0 ) {
          this._close();
        }
      },

      _computefilter: function ( string ) {
        if ( !string ) {
          return null;
        }
        else {
          string = string.toLowerCase();
          return function ( items ) {
            var value = items.value.toLowerCase(),
                key = items.key;
            return (
              value.indexOf( string ) != -1 ||
              key.indexOf( string ) != -1
            );
          };
        }
      },

      _selectItem: function ( item ) {
        //e.target.classList.add( 'is_selected' );
        var item = this.$.templateList.itemForElement( item );
        this.$.selector.select( item );
        return item;
      },

      _itemFocused: function ( e ) {
        this.$.inputSearch.value = e.target.innerText;
        //this.$.inputSearch.focus();

        this._selectItem( e.target );
      },

      _itemSelected: function ( e ) {
        var item;

        if ( event.type == 'click' ) {
          item = this._selectItem( e.target );
        }
        else if ( event.type == 'keys-pressed' ) {
          item = this._selectItem( e.detail.keyboardEvent.target );
        }

        this.fire( 'on-br-search-selected', { item: item } );

        this._close();
      }

    });
  </script>
</dom-module>